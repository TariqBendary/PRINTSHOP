document.getElementById('langBtn').addEventListener('click', () => {
  const html = document.documentElement;
  const isArabic = html.lang === 'ar';

  html.lang = isArabic ? 'en' : 'ar';
  html.dir = isArabic ? 'ltr' : 'rtl';

  document.querySelectorAll('[data-lang-ar]').forEach(el => {
    el.textContent = isArabic ? el.dataset.langEn : el.dataset.langAr;
  });

  document.querySelectorAll('[data-placeholder-ar]').forEach(el => {
    el.placeholder = isArabic ? el.dataset.placeholderEn : el.dataset.placeholderAr;
  });
});

document.getElementById('paperType').addEventListener('change', function () {
  const customInput = document.getElementById('customPaper');
  customInput.style.display = this.value === 'custom' ? 'block' : 'none';
});

document.getElementById('unsubscribeBtn').addEventListener('click', () => {
  if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ')) window.close();
});

// Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
document.querySelectorAll('input[name="extraNote"]').forEach(el => {
  el.addEventListener('change', function () {
    const container = document.getElementById('extraNotesTextareaContainer');
    const notesField = document.getElementById('notes');

    if (this.value === 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø®Ø±Ù‰') {
      container.style.display = 'block';
      notesField.value = '';
    } else {
      container.style.display = 'none';
      notesField.value = this.value;
    }
  });
});

document.getElementById('sendBtn').addEventListener('click', async () => {
  const printType = document.querySelector('input[name="printType"]:checked')?.value || '';
  const copies = document.getElementById('copies').value;
  const pages = document.getElementById('pages').value;
  const delivery = document.getElementById('delivery').value;

  const selectedNote = document.querySelector('input[name="extraNote"]:checked');
  let notes = selectedNote ? selectedNote.value : '';

  if (notes === 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø®Ø±Ù‰') {
    notes = document.getElementById('notes').value;
  }

  const paperType = document.getElementById('paperType').value === 'custom'
    ? document.getElementById('customPaper').value
    : document.getElementById('paperType').value;

  const printPrice = document.getElementById('printPriceBox').textContent;
  const deliveryPrice = document.getElementById('deliveryPriceBox').textContent;
  const total = document.getElementById('totalPriceBox').textContent;

  const address = document.getElementById('delivery').value.trim();
  let distance = null;
  let fee = 0;

  if (address) {
    distance = await getDistanceFromAddress(address);
    if (distance !== null) {
      fee = calculateDeliveryFee(distance);
    }
  }

  const now = new Date();
  const dateString = `${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, "0")}/${String(now.getDate()).padStart(2, "0")}`;
  const timeString = `${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;

  const orderNumber = Math.floor(Math.random() * 900000) + 100000;

  let message = `ðŸ–¨ï¸ Ø¨Ø±Ù†Øª Ø´ÙˆØ¨ - Ø·Ù„Ø¨ Ø·Ø¨Ø§Ø¹Ø©\n\n`;
  message += `ðŸ“… ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨: ${dateString} ${timeString}\n`;
  message += `ðŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: #${orderNumber}\n\n`;
  message += `ðŸ“ Ù†ÙˆØ¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${printType}\n`;
  message += `ðŸ“„ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®: ${copies}\n`;
  message += `ðŸ“„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚: ${pages}\n`;
  message += `ðŸ—’ï¸ Ù†ÙˆØ¹ Ø§Ù„ÙˆØ±Ù‚: ${paperType}\n`;
  message += `ðŸ“ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„: ${delivery}\n`;

  if (distance !== null) {
    message += `ðŸš— Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${distance.toFixed(1)} ÙƒÙ…\n`;
    message += `ðŸ’° Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„: ${fee.toFixed(3)} Ø¯.Ùƒ\n`;
  }

  if (notes) message += `ðŸ—‚ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${notes}\n\n`;

  message += `ðŸ’¸ Ø³Ø¹Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${printPrice}\n`;
  message += `ðŸ’¸ Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„: ${deliveryPrice}\n`;
  message += `ðŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total}`;

  window.open(`https://wa.me/96590010901?text=${encodeURIComponent(message)}`, '_blank');

  showPopup();
});

function showPopup() {
  const popup = document.getElementById('popup');
  popup.style.display = 'flex';
}

document.getElementById('popupClose').addEventListener('click', () => {
  document.getElementById('popup').style.display = 'none';
});

function calculatePrintPrice(printType, copies, pages) {
  let rate = printType === "Ù…Ù„ÙˆÙ†" ? 50 : 25;
  return (copies * pages * rate) / 1000;
}

const origin = { lat: 29.308770, lon: 47.940330 };

async function getDistanceFromAddress(address) {
  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
  const data = await res.json();

  if (!data.length) return null;

  const dest = {
    lat: parseFloat(data[0].lat),
    lon: parseFloat(data[0].lon)
  };

  return haversineDistance(origin.lat, origin.lon, dest.lat, dest.lon);
}

function deg2rad(deg) {
  return deg * (Math.PI / 180);
}

function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = deg2rad(lat2 - lat1);
  const dLon = deg2rad(lon2 - lon1);
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function calculateDeliveryFee(distance) {
  if (distance <= 10) return 2;
  if (distance <= 25) return 2.5;
  return 5;
}

async function updateDeliveryEstimation() {
  const address = document.getElementById('delivery').value.trim();
  const resultBox = document.getElementById('distanceResult');
  const estimatedBox = document.getElementById('estimatedDeliveryBox');

  if (!address) {
    resultBox.style.display = 'none';
    estimatedBox.textContent = "-";
    document.getElementById('deliveryPriceBox').textContent = `0 Ø¯.Ùƒ`;
    updateTotalPrice();
    return;
  }

  resultBox.textContent = "Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©...";
  resultBox.style.display = 'block';

  const distance = await getDistanceFromAddress(address);
  if (distance === null) {
    resultBox.textContent = "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†.";
    estimatedBox.textContent = "-";
    document.getElementById('deliveryPriceBox').textContent = `0 Ø¯.Ùƒ`;
    updateTotalPrice();
    return;
  }

  const fee = calculateDeliveryFee(distance);

  resultBox.textContent = `Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${distance.toFixed(1)} ÙƒÙ… â€” Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„: ${fee.toFixed(3)} Ø¯.Ùƒ`;
  estimatedBox.textContent = `${fee.toFixed(3)} Ø¯.Ùƒ`;
  document.getElementById('deliveryPriceBox').textContent = `${fee.toFixed(3)} Ø¯.Ùƒ`;

  updateTotalPrice();
}

function updateTotalPrice() {
  const printPriceText = document.getElementById('printPriceBox').textContent.replace(" Ø¯.Ùƒ", "") || "0";
  const deliveryPriceText = document.getElementById('deliveryPriceBox').textContent.replace(" Ø¯.Ùƒ", "") || "0";

  const printPrice = parseFloat(printPriceText) || 0;
  const deliveryPrice = parseFloat(deliveryPriceText) || 0;

  const total = printPrice + deliveryPrice;
  document.getElementById('totalPriceBox').textContent = `${total.toFixed(3)} Ø¯.Ùƒ`;
}

function updatePrices() {
  const printType = document.querySelector('input[name="printType"]:checked')?.value;
  const copies = Number(document.getElementById('copies').value);
  const pages = Number(document.getElementById('pages').value);

  const printPrice = (printType && copies && pages) ? calculatePrintPrice(printType, copies, pages) : 0;
  document.getElementById('printPriceBox').textContent = `${printPrice.toFixed(3)} Ø¯.Ùƒ`;

  updateTotalPrice();
}

['copies', 'pages'].forEach(id => {
  document.getElementById(id).addEventListener('input', updatePrices);
});
document.querySelectorAll('input[name="printType"]').forEach(el => {
  el.addEventListener('change', updatePrices);
});

document.getElementById('delivery').addEventListener('blur', () => {
  updateDeliveryEstimation();
});
